# 🤖 Async Telegram Analytics Bot - Telegram-бот для аналитики видео

> **Интеллектуальный бот для анализа видео-статистики через естественный язык**

Telegram-бот, который использует GPT-4o-mini для преобразования вопросов на русском языке в SQL-запросы и предоставляет аналитику по видео-контенту.

---

## 📖 Оглавление

- [Возможности](#-возможности)
- [Технологии](#-технологии)
- [Быстрый старт](#-быстрый-старт)
- [Использование](#-использование)
- [Архитектура](#-архитектура)
- [Docker](#-docker)
- [Документация](#-документация)

---

## ✨ Возможности

- 🗣️ **Естественный язык** - задавайте вопросы на русском
- 🤖 **Text-to-SQL через LLM** - автоматическая генерация SQL из текста
- ⚡ **Полностью асинхронный** - высокая производительность
- 🔢 **Точные ответы** - только числа, никаких галлюцинаций

---

## �️ Технологии

| Компонент | Технология | Версия |
|-----------|-----------|---------|
| Язык | Python | 3.11+ |
| Бот | aiogram | 3.x |
| БД | PostgreSQL | 15+ |
| ORM | SQLAlchemy + asyncpg | 2.x |
| LLM | OpenAI GPT-4o-mini | API |

---

## 🚀 Быстрый старт

### Вариант 1: Локальный запуск

#### 1️⃣ Клонирование и установка

```bash
git clone https://github.com/wh1tespirit/Async-Telegram-Analytics-Bot.git
cd Async-Telegram-Analytics-Bot
pip install -r requirements.txt
```

#### 2️⃣ Настройка окружения

Создайте `.env` файл:

```env
# Telegram Bot
BOT_TOKEN=1234567890:ABCdefGHIjklMNOpqrsTUVwxyz

# OpenAI API
OPENAI_API_KEY=sk-proj-xxxxxxxxxxxxx

# Database
DB_USER=postgres
DB_PASS=postgres
DB_HOST=localhost
DB_PORT=5432
DB_NAME=testbot
```

#### 3️⃣ Запуск PostgreSQL

```bash
psql -U postgres -c "CREATE DATABASE testbot;"
```

#### 4️⃣ Загрузка данных

```bash
python -m app.database.loader
```

#### 5️⃣ Запуск бота

```bash
python bot.py
```
---

## � Использование

### Команды бота

- `/start` - приветствие и примеры
- `/help` - справка по использованию

### Примеры запросов

```
Пользователь: Сколько всего видео?
Бот: 358

Пользователь: Сколько видео набрало больше 100000 просмотров?
Бот: 16

Пользователь: На сколько выросли просмотры 28 ноября 2025?
Бот: 18777

Пользователь: Сколько разных видео получали просмотры 27 ноября?
Бот: 243
```

### Типы вопросов

| Тип | Пример |
|-----|--------|
| Подсчет | "Сколько всего видео?" |
| Фильтрация | "Сколько видео набрало больше 1 млн просмотров?" |
| Временные диапазоны | "Сколько видео вышло с 1 по 5 ноября?" |
| Динамика | "На сколько выросли лайки за 28 ноября?" |
| Уникальность | "Сколько разных видео получали просмотры?" |

---

## 🏗️ Архитектура

### Общая схема

```
┌─────────────────┐
│   Пользователь  │
└────────┬────────┘
         │ Вопрос на русском
         ↓
┌─────────────────────────────────┐
│      Telegram Bot (aiogram)     │
└────────┬────────────────────────┘
         │
         ↓
┌─────────────────────────────────┐
│      Query Service              │
│   (координация компонентов)     │
└─────┬──────────────────┬────────┘
      │                  │
      ↓                  ↓
┌──────────────┐   ┌─────────────┐
│ LLM Service  │   │SQL Executor │
│ GPT-4o-mini  │   │ PostgreSQL  │
└──────┬───────┘   └──────┬──────┘
       │                  │
       │ SQL Query        │ Result
       └──────────┬───────┘
                  ↓
         ┌────────────────┐
         │  Ответ (число)  │
         └────────────────┘
```

### Структура проекта

```
TestBot/
├── bot.py                      # 🚀 Точка входа
├── app/
│   ├── database/
│   │   ├── models.py           # 📊 SQLAlchemy модели
│   │   ├── db.py               # 🔌 Подключение к БД
│   │   ├── loader.py           # 📥 ETL для загрузки данных
│   │   └── data/videos.json    # 📁 Исходные данные
│   ├── services/
│   │   ├── llm_service.py      # 🧠 Text-to-SQL через GPT
│   │   ├── sql_executor.py     # 💾 Выполнение SQL
│   │   └── query_service.py    # 🎯 Главный сервис
│   └── storage/
│       └── config.py           # ⚙️ Конфигурация
├── docker-compose.yml          # 🐳 Docker конфигурация
├── Dockerfile                  # 🐳 Образ приложения
├── requirements.txt            # 📦 Зависимости
└── .env                        # 🔐 Переменные окружения
```

### База данных

**Таблица `videos`** - итоговая статистика:
```sql
id, creator_id, video_created_at, 
views_count, likes_count, comments_count, reports_count
```

**Таблица `video_snapshots`** - почасовые замеры:
```sql
id, video_id, created_at,
views_count, delta_views_count,
likes_count, delta_likes_count, ...
```

📚 **Подробнее:** [DATABASE_SCHEMA.md](DATABASE_SCHEMA.md)

### LLM Промпт (Text-to-SQL)

Системный промпт содержит:

1. **Полное описание схемы БД** (DDL-style)
2. **6 примеров запросов** (few-shot learning)
3. **Правила генерации SQL**:
   - Только SELECT, COUNT, SUM
   - Приведение дат через `::date`
   - Использование COALESCE для NULL
4. **Контекстная информация** (текущая дата, год по умолчанию)

📚 **Подробнее:** [LLM_SERVICE.md](LLM_SERVICE.md)

---

## 🧪 Тестирование

### Тест базы данных

```bash
python -m app.database.test_db
```

### Тест LLM-сервиса

```bash
python test_llm.py                # Автоматические тесты
python test_llm.py --interactive  # Интерактивный режим
```

---

## 📚 Документация

- [DATABASE_SCHEMA.md](DATABASE_SCHEMA.md) - схема БД и примеры SQL
- [LLM_SERVICE.md](LLM_SERVICE.md) - архитектура Text-to-SQL

---

## � Ключевые особенности

### ⚡ Полная асинхронность

```python
# Все на async/await
await bot.send_message(...)      # aiogram
await session.execute(query)     # asyncpg
await client.chat.completions()  # AsyncOpenAI
```

### 🎯 Надежность

- **Обработка ошибок** на всех уровнях
- **Валидация SQL** перед выполнением
- **Логирование** всех операций
- **Graceful shutdown** при остановке

### 🚀 Производительность

- **Bulk insert** при загрузке данных (5000+ записей/сек)
- **Индексы** на часто используемых полях
- **Connection pooling** для БД

---

## � Лицензия

MIT License - свободное использование

---

## 👨‍� Автор

Разработано как тестовое задание для позиции **Python Developer**

---

## 🤝 Поддержка

Возникли вопросы? Откройте Issue в репозитории или свяжитесь с автором.

**Приятного использования! 🚀**
